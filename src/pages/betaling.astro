---
import Layout from '../layouts/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';

// Get query parameters from URL
const url = new URL(Astro.request.url);
const product = url.searchParams.get('product');
const amount = url.searchParams.get('amount');
const order = url.searchParams.get('order');

// Handle PayPro payment creation
let paymentResponse = null;
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const dataString = formData.get('data') as string | null;
    
    console.log('[PayPro] Received POST request');
    console.log('[PayPro] FormData keys:', Array.from(formData.keys()));
    console.log('[PayPro] Data string:', dataString);
    
    if (!dataString) {
      console.error('[PayPro] No data in form submission');
      paymentResponse = { 
        error: true, 
        message: 'Geen betaalgegevens ontvangen. Probeer het opnieuw.' 
      };
    } else {
      const paymentData = JSON.parse(dataString);
      
      const apiKey = import.meta.env.PAYPRO_API_KEY;
      const productId = import.meta.env.PAYPRO_PRODUCT_ID;
      const testMode = import.meta.env.PAYPRO_TEST_MODE === 'true';
      
      console.log('[PayPro] Creating payment:', {
        productId,
        customer: paymentData.customer?.email,
        testMode,
        orderDetails: paymentData.orderDetails
      });
      
      // Flatten metadata - PayPro doesn't accept nested objects
      const details = paymentData.orderDetails?.details || {};
      const flatMetadata = {
        product: paymentData.orderDetails?.product || '',
        amount: paymentData.orderDetails?.amount || '',
        distance: details.distance || '',
        pipeSize: details.pipeSize || '',
        kabelgoot: details.kabelgoot || '',
        beugel: details.beugel || '',
        multisplitUnits: String(details.multisplitUnits || 0),
        inbedrijfstelling: String(details.inbedrijfstelling || false),
        subtotal: String(details.subtotal || 0),
        shipping: String(details.shipping || 0),
        totalPrice: String(details.totalPrice || 0)
      };
      
      // New PayPro Payments API uses JSON
      const paymentRequest = {
        amount: paymentData.orderDetails?.details?.totalPrice ? Math.round(paymentData.orderDetails.details.totalPrice * 100) : 0,
        currency: 'EUR',
        description: `Airco Aansluitpakket - ${paymentData.orderDetails?.details?.distance || 'Bestelling'}`,
        return_url: `${Astro.url.origin}/betaling/success`,
        cancel_url: `${Astro.url.origin}/betaling/cancel`,
        webhook_url: `${Astro.url.origin}/api/paypro-webhook`,
        customer: {
          email: paymentData.customer?.email || ''
        },
        metadata: flatMetadata
      };
      
      if (testMode) {
        paymentRequest.test_mode = true;
      }
      
  console.log('[PayPro] Request payload:', JSON.stringify(paymentRequest, null, 2));

  const response = await fetch('https://api.paypro.nl/payments', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify(paymentRequest)
  });      const responseText = await response.text();
      console.log('[PayPro] Raw response status:', response.status);
      console.log('[PayPro] Raw response text:', responseText.substring(0, 500));
      
      if (!response.ok) {
        console.error('[PayPro] HTTP error:', response.status, response.statusText);
        paymentResponse = { 
          error: true, 
          message: `PayPro API error: ${response.status} ${response.statusText}` 
        };
      } else {
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          console.error('[PayPro] Failed to parse JSON:', parseError);
          console.error('[PayPro] Response text:', responseText);
          paymentResponse = { 
            error: true, 
            message: 'Invalid response from payment service' 
          };
          result = null;
        }
        
        // PayPro API returns checkout URL in _links.checkout
        if (result && result._links?.checkout) {
          console.log('[PayPro] Redirecting to:', result._links.checkout);
          return Astro.redirect(result._links.checkout);
        } else if (result && result.error) {
          console.error('[PayPro] API returned error:', result.error);
          paymentResponse = { 
            error: true, 
            message: 'Payment creation failed: ' + (result.error.message || JSON.stringify(result.error))
          };
        } else if (result) {
          console.error('[PayPro] Unexpected response format:', result);
          paymentResponse = { 
            error: true, 
            message: 'Unexpected response from payment service' 
          };
        }
      }
    }
  } catch (error) {
    console.error('[PayPro] Error:', error);
    paymentResponse = { 
      error: true, 
      message: error instanceof Error ? error.message : String(error) 
    };
  }
}
---

<Layout 
  title="Betaling - Technische Service Assen"
  description="Veilig betalen voor uw bestelling"
  background="/assets/afbeeldingupload/responsive/daikin-in bedrijfstelling-groningen-1440w.avif"
  withOverlay
>
  <!-- Hero Section -->
  <section class="hc-hero hero-left">
    <div class="hc-container">
      <Breadcrumbs items={[{ name: 'Home', href: '/' }, { name: 'Betaling' }]} />
      <div class="hero-grid">
        <div class="hero-content">
          <span class="hero-eyebrow">Veilig Betalen</span>
          <h1 class="hc-title">Betaling</h1>
          <p class="hero-subtitle">Kies uw betaalmethode om de bestelling af te ronden</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Payment Section -->
  <section class="hc-section">
    <div class="hc-container max-w-3xl">
      
      <!-- Order Summary -->
      <div id="order-summary" class="mb-12">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-20 h-20 bg-green-500/20 rounded-full mb-4 backdrop-blur-sm border border-green-500/30">
            <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h2 class="text-3xl font-bold text-white mb-2">Bestelling Ontvangen!</h2>
          <p class="text-slate-300">Kies uw betaalmethode om de bestelling af te ronden</p>
        </div>
        
        <div class="bg-blue-500/10 border-2 border-blue-500/30 rounded-xl p-6 mb-12 backdrop-blur-sm">
          <h3 class="font-semibold text-white mb-4 text-lg">Uw bestelling:</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-slate-300">Product:</span>
              <strong class="text-white">{order}</strong>
            </div>
            <div class="flex justify-between items-center pt-3 border-t border-blue-500/30">
              <span class="text-slate-300 text-lg font-semibold">Totaalbedrag:</span>
              <strong class="text-blue-400 text-3xl font-bold">€{amount},-</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div id="payment-methods" class="space-y-4 mb-12">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">Kies betaalmethode</h2>
        
        <!-- iDEAL Payment -->
        <button onclick="selectPaymentMethod('ideal')" class="payment-method-btn w-full bg-white/5 backdrop-blur-sm border-2 border-white/10 rounded-xl p-6 hover:bg-white/10 hover:border-white/20 transition-all">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-pink-500/20 rounded-lg flex items-center justify-center border border-pink-500/30">
                
              </div>
              <div class="text-left">
                <h3 class="text-xl font-bold text-white">iDEAL</h3>
                <p class="text-sm text-slate-300">Direct betalen via uw bank</p>
                <span class="text-xs text-green-400 font-semibold">Meest gekozen</span>
              </div>
            </div>
            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </button>

        <!-- Bank Transfer -->
        <button onclick="selectPaymentMethod('banktransfer')" class="payment-method-btn w-full bg-white/5 backdrop-blur-sm border-2 border-white/10 rounded-xl p-6 hover:bg-white/10 hover:border-white/20 transition-all">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-blue-500/20 rounded-lg flex items-center justify-center border border-blue-500/30">
                
              </div>
              <div class="text-left">
                <h3 class="text-xl font-bold text-white">Bankoverschrijving</h3>
                <p class="text-sm text-slate-300">Handmatig overmaken naar ons rekeningnummer</p>
              </div>
            </div>
            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </button>
      </div>

      <!-- iDEAL Details (hidden initially) -->
      <div id="ideal-details" class="hidden mt-8 border-t-2 border-white/10 pt-8"></div>

      <!-- Bank Transfer Details (hidden initially) -->
      <div id="banktransfer-details" class="hidden mt-8 border-t-2 border-white/10 pt-8"></div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center">
        <div class="mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full backdrop-blur-sm border border-red-500/30">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
        </div>
        <h2 class="text-2xl font-bold text-white mb-4">Oeps, er ging iets mis</h2>
        <p class="text-slate-300 mb-8">We konden de betaling niet starten. Geen zorgen, er is nog niets afgeschreven.</p>
        
        <div class="space-y-4">
          <button onclick="window.location.reload()" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">
            Opnieuw proberen
          </button>
          <a href="/airco-aansluitpakket" class="block w-full bg-white/10 text-white font-semibold py-3 px-6 rounded-lg hover:bg-white/20 transition-colors border border-white/20">
            Terug naar configurator
          </a>
          <a href="tel:0658980933" class="block text-blue-400 hover:text-blue-300">
            Of bel ons: 06-58980933
          </a>
        </div>
      </div>

      <!-- Security badges -->
      <div class="mt-8 text-center">
        <div class="flex items-center justify-center gap-4 text-slate-400 text-sm">
          <span>SSL Beveiligd</span>
          <span>•</span>
          <span>Alle betaalmethoden</span>
          <span>•</span>
          <span>Veilig betalen</span>
        </div>
      </div>

    </div>
  </section>
</Layout>

<script define:vars={{ product, amount, order }}>
  // Payment method selection
  async function selectPaymentMethod(method) {
    const button = event?.target?.closest('button');
    
    // Disable all buttons during processing
    document.querySelectorAll('.payment-method').forEach(btn => {
      btn.disabled = true;
    });

    try {
      // Get order data from sessionStorage
      const orderDataStr = sessionStorage.getItem('airco-order');
      if (!orderDataStr) {
        alert('Geen bestelling gevonden. Ga terug naar het formulier.');
        window.location.href = '/airco-aansluitpakket';
        return;
      }

      const orderData = JSON.parse(orderDataStr);
      
      if (method === 'ideal') {
        // Create payment via server-side form POST
        console.log('[Betaling] Creating PayPro payment...');
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/betaling';
        
        const dataInput = document.createElement('input');
        dataInput.type = 'hidden';
        dataInput.name = 'data';
        dataInput.value = JSON.stringify({
          customer: {
            email: orderData.customerEmail || '',
            name: orderData.customerName || ''
          },
          pspCode: '0021', // Bank selection code for iDEAL
          orderDetails: {
            product: orderData.product || '',
            amount: orderData.amount || '',
            details: orderData.orderDetails || {}
          }
        });
        
        form.appendChild(dataInput);
        document.body.appendChild(form);
        form.submit();
      } else if (method === 'bank') {
        // Show bank transfer details
        alert('Bankoverschrijving: Neem contact op voor de betaalgegevens via 06-58980933');
        // Re-enable buttons
        document.querySelectorAll('.payment-method').forEach(btn => {
          btn.disabled = false;
        });
      }
    } catch (error) {
      console.error('[Betaling] Error:', error);
      alert('Er ging iets mis. Probeer het opnieuw of neem contact op.');
      // Re-enable buttons
      document.querySelectorAll('.payment-method').forEach(btn => {
        btn.disabled = false;
      });
    }
  }

  // Make function globally available
  window.selectPaymentMethod = selectPaymentMethod;

  // Initialize page
  document.addEventListener('DOMContentLoaded', () => {
    // Check if we have order data
    const orderDataStr = sessionStorage.getItem('airco-order');
    if (!orderDataStr) {
      // No order data - redirect to form
      console.warn('[Betaling] No order data found');
      setTimeout(() => {
        window.location.href = '/airco-aansluitpakket';
      }, 2000);
    } else {
      console.log('[Betaling] Order data found, ready for payment');
    }
  });
</script>

<style>
  .payment-method {
    transition: all 0.2s;
  }
  
  .payment-method:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
