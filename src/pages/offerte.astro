---
import Layout from '../layouts/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
---

<Layout title="Gratis Offerte Aanvragen - Technische Service Assen" withOverlay background="/assets/portfolio/responsive/sinclair-vries-1440w.jpg">
	<!-- Hero Section -->
	<section class="hc-section">
		<div class="hc-container text-center">
					<Breadcrumbs items={[{ name: 'Home', href: '/' }, { name: 'Offerte' }]} />
					<h1 class="hc-title mb-4">Gratis Offerte Aanvragen</h1>
					<p class="hc-subtitle mb-8">Vul het formulier in en wij nemen binnen 24 uur contact op voor een gratis adviesgesprek.</p>
				</div>
	</section>

	<!-- Contact Form -->
	<section class="hc-section">
		<div class="hc-container">
			<div class="max-w-2xl mx-auto">
				<div class="hc-block">
							<h2 class="hc-block-title mb-6">Offerte Formulier</h2>
							<form id="offerte-form" class="space-y-6" novalidate>
								<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
									<div class="form-group">
										<label for="voornaam" class="form-label">Voornaam *</label>
										<input type="text" id="voornaam" name="voornaam" required class="form-input" placeholder="Uw voornaam">
									</div>
									<div class="form-group">
										<label for="achternaam" class="form-label">Achternaam *</label>
										<input type="text" id="achternaam" name="achternaam" required class="form-input" placeholder="Uw achternaam">
									</div>
								</div>

								<div class="form-group">
									<label for="telefoon" class="form-label">Telefoonnummer *</label>
									<input type="tel" id="telefoon" name="telefoon" required class="form-input" placeholder="06-...">
									<p class="form-helper">We gebruiken dit alleen voor contact over uw aanvraag.</p>
								</div>

								<div class="form-group">
									<label for="email" class="form-label">E-mailadres *</label>
									<input type="email" id="email" name="email" required class="form-input" placeholder="naam@voorbeeld.nl">
								</div>

								<div class="form-group">
									<label for="adres" class="form-label">Adres (voor installatie) *</label>
									<input type="text" id="adres" name="adres" required class="form-input" placeholder="Straat en huisnummer">
								</div>

								<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
									<div class="form-group">
										<label for="postcode" class="form-label">Postcode *</label>
										<input type="text" id="postcode" name="postcode" required class="form-input" placeholder="1234 AB">
									</div>
									<div class="form-group">
										<label for="woonplaats" class="form-label">Woonplaats *</label>
										<input type="text" id="woonplaats" name="woonplaats" required class="form-input" placeholder="Plaatsnaam">
									</div>
								</div>

								<div class="form-group">
									<label for="service" class="form-label">Gewenste service *</label>
									<select id="service" name="service" required class="form-input">
										<option value="">Selecteer een service</option>
										<option value="airco">Airco Installatie</option>
										<option value="quooker">Quooker Installatie</option>
										<option value="waterontharder">Waterontharder</option>
										<option value="meerdere">Meerdere services</option>
										<option value="advies">Adviesgesprek</option>
									</select>
								</div>

								<div class="form-group">
									<label for="personen" class="form-label">Aantal personen in huishouden</label>
									<select id="personen" name="personen" class="form-input">
										<option value="">Selecteer aantal</option>
										<option value="1-2">1-2 personen</option>
										<option value="3-4">3-4 personen</option>
										<option value="5-6">5-6 personen</option>
										<option value="7+">7 of meer personen</option>
									</select>
								</div>

								<div class="form-group">
									<label for="datum" class="form-label">Gewenste installatiedatum</label>
									<input type="date" id="datum" name="datum" class="form-input">
								</div>

								<div class="form-group">
									<label for="opmerkingen" class="form-label">Opmerkingen of vragen</label>
									<textarea id="opmerkingen" name="opmerkingen" rows="4" class="form-textarea" placeholder="Vertel ons meer over uw wensen of stel uw vragen..."></textarea>
								</div>

								<!-- Honeypot field (verborgen) -->
								<div style="position:absolute;left:-9999px;top:-9999px;" aria-hidden="true">
									<label for="website">Website</label>
									<input type="text" id="website" name="website" tabindex="-1" autocomplete="off" />
								</div>

								<div class="flex items-start">
									<input type="checkbox" id="privacy" name="privacy" required class="mt-1 mr-3">
									<label for="privacy" class="text-sm text-slate-300">Ik ga akkoord met het <a href="/privacy" class="text-orange-400 hover:underline">privacybeleid</a> en geef toestemming voor het verwerken van mijn gegevens voor het versturen van een offerte. *</label>
								</div>

																<button id="submit-btn" type="submit" class="btn btn-primary w-full text-lg py-4" aria-live="polite">
																	<span class="btn-text">Verstuur Offerte Aanvraag</span>
																</button>
							</form>

							<!-- Success message -->
							<div id="success-message" class="hidden mt-6 hc-outline p-4 rounded-lg" role="status" aria-live="polite">
								<div class="flex">
									<div>
										<h3 class="font-medium text-slate-200">Bedankt voor uw aanvraag!</h3>
										<p class="text-slate-300 text-sm mt-1">We nemen binnen 24 uur contact met u op voor de planning van uw gratis adviesgesprek. Heeft u haast? Bel ons direct via <a class="text-orange-300 underline" href="tel:0658980933">06-58980933</a>.</p>
									</div>
								</div>
							</div>

							<!-- Error message -->
							<div id="error-message" class="hidden mt-6 hc-outline p-4 rounded-lg" role="alert" aria-live="assertive">
								<div class="flex">
									<div>
										<h3 class="font-medium text-slate-200">Er is iets misgegaan</h3>
										<p class="text-slate-300 text-sm mt-1">Probeer het opnieuw of bel ons direct op <a class="text-orange-300 underline" href="tel:0658980933">06-58980933</a>.</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
	</section>

	<!-- Alternative Contact -->
	<section class="hc-section">
		<div class="hc-container">
			<div class="text-center mb-12">
						<h2 class="hc-title mb-3">Liever direct contact?</h2>
						<p class="hc-subtitle">Geen probleem! U kunt ons ook direct bereiken</p>
					</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
						<div class="hc-block text-center">
							<h3 class="hc-block-title mb-2">Bel Direct</h3>
							<p class="text-slate-300 mb-4">Directe hulp en advies van onze specialisten</p>
							<a href="tel:0658980933" class="btn btn-primary text-lg">06-58980933</a>
						</div>

						<div class="hc-block text-center">
							<h3 class="hc-block-title mb-2">E-mail</h3>
							<p class="text-slate-300 mb-4">Stuur uw vraag per e-mail</p>
							<a href="mailto:info@technischeservice.nl" class="btn btn-outline text-lg">info@technischeservice.nl</a>
						</div>
			</div>
		</div>
	</section>
			<script>
				// @ts-nocheck
				// Basis spamdetectie: honeypot, tijdsdrempel, throttling en simpele inhoudscheck
								document.addEventListener('DOMContentLoaded', function() {
					const formEl = document.getElementById('offerte-form');
					const form = formEl instanceof HTMLFormElement ? formEl : null;
					const successMessage = document.getElementById('success-message');
					const errorMessage = document.getElementById('error-message');
										const submitBtn = document.getElementById('submit-btn');
										const submitText = submitBtn?.querySelector('.btn-text');
					const startTime = Date.now();
					const MIN_SECONDS = 3; // minimaal tijd op pagina
					const lastSubmissionKey = 'offerte-last';
					const REPEAT_INTERVAL_MS = 60 * 1000; // 1 minuut
					const spamPhrases = [/free money/i, /bitcoin/i, /crypto/i, /viagra/i, /loan/i];

										/** @param {boolean} loading */
										function setLoading(loading) {
											if (!form) return;
											if (submitBtn && 'disabled' in submitBtn) {
												submitBtn.disabled = !!loading;
												submitBtn.ariaBusy = loading ? 'true' : 'false';
											}
											if (submitText) submitText.textContent = loading ? 'Versturenâ€¦' : 'Verstuur Offerte Aanvraag';
											const inputs = form.querySelectorAll('input, select, textarea, button');
											inputs.forEach(el => {
												if (el instanceof HTMLButtonElement && el.type === 'submit') return;
												if ('disabled' in el) el.disabled = !!loading;
											});
										}

										form?.addEventListener('submit', async function(e) {
						e.preventDefault();
						const f = e.currentTarget;
						if (!(f instanceof HTMLFormElement)) return;

						successMessage?.classList.add('hidden');
						errorMessage?.classList.add('hidden');

						const formData = new FormData(f);
						const data = Object.fromEntries(formData.entries());

											// HTML5 required velden checken
											if (!f.reportValidity()) {
												return;
											}						// Honeypot: echte gebruikers laten dit leeg
						if (data['website']) {
							return showError('Spam gedetecteerd.');
						}

						// Tijdsdrempel
						const elapsedSec = (Date.now() - startTime) / 1000;
						if (elapsedSec < MIN_SECONDS) {
							return showError('Formulier te snel verzonden, probeer opnieuw.');
						}

						// Herhaal-beperking
						const last = parseInt(localStorage.getItem(lastSubmissionKey) || '0', 10);
						if (Date.now() - last < REPEAT_INTERVAL_MS) {
							return showError('Te snel opnieuw verzonden, wacht even.');
						}

						// E-mailpatroon
						const email = (data['email'] || '').toString().trim();
						const emailOk = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
						if (!emailOk) {
							return showError('Ongeldig e-mailadres.');
						}

						// Simpele spamfrases in opmerkingen
						const opmerkingen = (data['opmerkingen'] || '').toString();
						if (spamPhrases.some(r => r.test(opmerkingen))) {
							return showError('Inhoud lijkt op spam.');
						}

											try {
												setLoading(true);
											const resp = await fetch('/api/offerte', {
												method: 'POST',
												headers: { 'content-type': 'application/json' },
												body: JSON.stringify(data)
											});
											const json = await resp.json().catch(()=>({ ok:false }));
											if (!resp.ok || !json?.ok) {
												const msg = json?.message || 'Versturen mislukt. Probeer later opnieuw.';
												return showError(msg);
											}
											localStorage.setItem(lastSubmissionKey, Date.now().toString());
											showSuccess();
											if (f && 'reset' in f) f.reset();
											successMessage?.focus?.();
										} catch (err) {
											showError('Technische fout, probeer later opnieuw.');
											} finally {
												setLoading(false);
										}
					});

										function showError(msg: string) {
						if (!errorMessage) return;
						const p = errorMessage.querySelector('p');
						if (p) p.textContent = msg;
						errorMessage.classList.remove('hidden');
						errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
											submitBtn?.focus?.();
					}

										function showSuccess() {
						if (!successMessage) return;
						successMessage.classList.remove('hidden');
						successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
											// Voorkom per ongeluk dubbel verzenden binnen korte tijd
											submitBtn?.setAttribute('disabled', 'true');
											setTimeout(()=> submitBtn?.removeAttribute('disabled'), 15000);
					}
				});
			</script>
</Layout>